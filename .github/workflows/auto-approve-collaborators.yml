name: Auto Approve Collaborators

on:
  issues:
    types: [opened]

jobs:
  auto-approve:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.title, 'Become a collaborator')
    steps:
      - name: Extract username from issue title
        id: extract_username
        run: |
          USERNAME=$(echo "${{ github.event.issue.title }}" | sed 's/Become a collaborator - //')
          echo "username=$USERNAME" >> $GITHUB_OUTPUT
          echo "Extracted username: $USERNAME"
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.COLLABORATOR_TOKEN }}
      
      - name: Add collaborator
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.COLLABORATOR_TOKEN }}
          script: |
            const username = '${{ steps.extract_username.outputs.username }}';
            console.log(`Attempting to add ${username} as collaborator...`);
            
            try {
              // æ·»åŠ åä½œè€…
              await github.rest.repos.addCollaborator({
                owner: context.repo.owner,
                repo: context.repo.repo,
                username: username,
                permission: 'push'
              });
              
              console.log(`Successfully added ${username} as collaborator`);
              
              // æ·»åŠ approvedæ ‡ç­¾
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['approved', 'contribution-approved']
              });
              
              console.log(`Added approved labels to issue #${context.issue.number}`);
              
              // å…³é—­issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                state: 'closed'
              });
              
              console.log(`Closed issue #${context.issue.number}`);
              
              // æ·»åŠ è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `ðŸŽ‰ Congratulations! Your contributor application has been automatically approved!\n\nYou are now a collaborator of the **${context.repo.repo}** repository, and can start contributing code.\n\nWelcome to our project!`
              });
              
            } catch (error) {
              console.error('Error adding collaborator:', error);
              
              // å¦‚æžœæ·»åŠ åä½œè€…å¤±è´¥ï¼Œæ·»åŠ é”™è¯¯æ ‡ç­¾
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['error', 'needs-manual-review']
              });
              
              // æ·»åŠ é”™è¯¯è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âŒ è‡ªåŠ¨æ‰¹å‡†å¤±è´¥ï¼š${error.message}\n\nè¯·ä»“åº“ç®¡ç†å‘˜æ‰‹åŠ¨å¤„ç†æ­¤ç”³è¯·ã€‚`
              });
              
              // å¦‚æžœå¤±è´¥ï¼ŒæŠ›å‡ºé”™è¯¯ä»¥åœæ­¢åŽç»­æ­¥éª¤
              throw error;
            }
      
      - name: Update collaborators.txt
        run: |
          USERNAME='${{ steps.extract_username.outputs.username }}'
          FILE_PATH='.github/collaborators.txt'
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$FILE_PATH" ]; then
            echo "Creating $FILE_PATH..."
            mkdir -p .github
            echo "$USERNAME" > "$FILE_PATH"
          else
            # æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
            if ! grep -Fxq "$USERNAME" "$FILE_PATH"; then
              echo "Adding $USERNAME to $FILE_PATH..."
              echo "$USERNAME" >> "$FILE_PATH"
            else
              echo "$USERNAME already exists in $FILE_PATH"
            fi
          fi
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .github/collaborators.txt
          git diff --staged --quiet || git commit -m "chore: add ${{ steps.extract_username.outputs.username }} to collaborators.txt [skip ci]"
          git push
